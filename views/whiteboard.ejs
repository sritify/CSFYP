<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Interactive Whiteboard Room ID: <%= room %></title>
<!--
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
 --> 
	<link rel="stylesheet" href="colorpicker/css/colorpicker.css" type="text/css" />
    <link rel="stylesheet" media="screen" type="text/css" href="colorpicker/css/layout.css" />
	<script type="text/javascript" src="colorpicker/js/jquery.js"></script>
	<script type="text/javascript" src="colorpicker/js/colorpicker.js"></script>
    <script type="text/javascript" src="colorpicker/js/eye.js"></script>
    <script type="text/javascript" src="colorpicker/js/utils.js"></script>
    <script type="text/javascript" src="colorpicker/js/layout.js?ver=1.0.2"></script>
	<script src="/menucontrol.js" type="text/javascript" charset="utf-8"></script>
	<script src="/fabric.js" type="text/javascript" charset="utf-8"></script>
	<script src="/client.js" type="text/javascript" charset="utf-8"></script>  
	<script src="/RecordRTC.js" type="text/javascript" charset="utf-8"> </script>
	<script src="/status.js" type="text/javascript" charset="utf-8"> </script>
	<script src="/semantic/uncompressed/modules/popup.js" type="text/javascript" charset="utf-8"> </script>
	
	
	<!-- special IE-only canvas fix -->
	<!--[if IE]>
		<script type="text/javascript" src="/360player/excanvas.js"></script>
	<![endif]-->

	<!-- Apache-licensed animation library -->
	<script type="text/javascript" src="/360player/berniecode-animator.js"></script>

	<!-- the core stuff -->
	<script type="text/javascript" src="/360player/soundmanager2.js"></script>
	<script type="text/javascript" src="/360player/360player.js"></script>

	<link href="/360player/360player.css" rel="stylesheet" type="text/css"  />
	<link href="/menu.css" rel="stylesheet" type="text/css">
	<link href="/control.css" rel="stylesheet" type="text/css">
	<link href="/layout.css" rel="stylesheet" type="text/css">
	<link href="/popup.css" rel="stylesheet" type="text/css">
	<link href="/chat.css" rel="stylesheet" type="text/css">
	<link href="/segment.css" rel="stylesheet" type="text/css">
	<link href="/mainmenu_sub.css" rel="stylesheet" type="text/css">
	<link href="/status.css" rel="stylesheet" type="text/css">
	<link href="/semantic/uncompressed/modules/popup.css" rel="stylesheet" type="text/css">
	
	
  <script src="/layout.js" type="text/javascript" charset="utf-8"></script> 
  <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
  <script src="http://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
  <script src="/jquery_UI_touch.js" type="text/javascript" charset="utf-8"></script>
  <!-- <script src="jquery.nicescroll.js"></script> -->
  
      <!-- <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script> -->
    <link type="text/css"
		href="http://ajax.googleapis.com/ajax/libs/jqueryui/1/themes/redmond/jquery-ui.css" rel="stylesheet" />
    <!-- <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1/jquery-ui.min.js"></script> -->
  	<script type="text/javascript" src="https://www.youtube.com/iframe_api"></script>
	
	<script src="/jquery.youtubepopup.js" type="text/javascript"  charset="utf-8"></script>
	<script src="/try.js" type="text/javascript"  charset="utf-8"></script>
	<script type="text/javascript" src="detectmobilebrowser.js"  charset="utf-8"></script>
  <script>
	$(function() {
		$( ".draggable" ).draggable({containment:"window"});
	});
	window.mobilecheck = function() {
		var check = false;
		(function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4)))check = true})(navigator.userAgent||navigator.vendor||window.opera);
		return check; 
	}
	//var scrollObj;
	$(document).ready(function() { 
			document.getElementById("container").addEventListener('touchmove', function(event) {
		  event.preventDefault();
		}, false); 
		/*scrollObj = $("#container").niceScroll(
		 {
		  //touchbehavior: true,
		  //cursordragontouch: true
		 }
		);

		scrollObj.scrollstart(function(info){
			//console.log("scroll start");
			client.canvas2.calcOffset();
		});		
		scrollObj.scrollend(function(info){
			//console.log("scroll end");
			client.canvas2.calcOffset();
		});
		
		
		setTimeout(function(){scrollObj.resize();}, 210);
/*		scrollObj.locked=true;
		if(!window.mobilecheck()){
			scrollObj.locked=false;
		}*/
		if (window.mobilecheck()) {
			//create an AJAX request for the CSS file
			$.ajax({
				url     : 'jquery.mobile-1.4.2.min.css',
				success : function (response) {
					$('head').append('<style>' + response + '</style>');
				}
			});

			//create an AJAX request for the JS file, setting the dataType to 'script' will have jQuery automatically evaluate the JS code in the global scope
			$.ajax({
				url      : 'jquery.mobile-1.4.2.min.js',
				dataType : 'script'
			});
		
		}
	}); 
/*	$( window ).resize(function() {
		//console.log("resize");
		//scrollObj.resize();
		client.canvas2.calcOffset();
	});*/
  </script>

</head>
<body>
	<div id='control'>
		<ul>
			<li class='control_menu'><a href="/home">
				<button>
					<img src="/image/home.png" alt="Home" title="Home" >
				</button></a>
			</li>
			<li class='control_menu'><a>
				<button onclick="erase()">
					<img src="/image/clear.png" alt="Clear" title="Clear" >
				</button></a>
			</li>		

<!-- TOOLs -->			
			<li id='tool' class='holdable control_menu'><a>
				<button id='current_tool' onclick="">
					<img id='toolsimg' src="/image/pencil.png" alt="Tools" title="Tools"  >
				</button></a>	
			</li>
			<div class='toolbar'>
				<ul>
					<li id='pencil' class='control_tool active_tool'><a>
						<button onclick="setFunc('draw')">
							<img src="/image/pencil.png" alt="Pencil" title="Pencil"></button></a>
					</li>
					<li id='rectangle' class='control_tool'><a>
						<button onclick="setFunc('drawRect')">
							<img src="/image/rectangle.png" alt="Rectangle" title="Rectangle"></button></a>
					</li>
					<li id='square' class='control_tool'><a>
						<button onclick="setFunc('drawSquare')">
							<img src="/image/square.png" alt="Square" title="Square"></button></a>
					</li>
					<li id='oval' class='control_tool'><a>
						<button onclick="setFunc('drawOval')">
							<img src="/image/oval.png" alt="Oval" title="Oval"></button></a>
					</li>
					<li id='circle' class='control_tool'><a>
						<button onclick="setFunc('drawCircle')">
							<img src="/image/circle.png" alt="Circle" title="Cirlce"></button></a>
					</li>
					<li id='line' class='control_tool'><a>
						<button onclick="setFunc('drawLine')">
							<img src="/image/line.png" alt="Line" title="Line"></button></a>
					</li>
				</ul>
			</div>
						
			
			<li class='holdable control_menu active_menu'><a>
				<button onclick="select()">
					<img src="/image/select.png" alt="Select" title="Select" >
				</button></a> 
			</li>
			<li class='holdable control_menu'><a>
				<button onclick="setFunc('text'); openPopup('texteditor');">
					<img src="/image/text.png" alt="Text" title="Text" >
				</button></a>
			</li>
			<li class='holdable control_menu'><a>
				<button onclick="setFunc('latex'); openPopup('imageuploader2');">
					<img src="/image/pi.png" alt="Latex" title="Latex" >
				</button></a>
			</li>
			<li class='holdable control_menu'><a>
				<button onclick="setFunc('image');openPopup('imageuploader')">
					<img src="/image/insert_image.png" alt="Insert Image" title="Insert Image" >
				</button></a>
			</li>	
			<li class='control_menu'><a>
				<button onclick="removeObject();">
					<img src="/image/eraser.png" alt="Remove Object" title="Remove Object" >
				</button></a>
			</li>
			<li class='control_menu'><a>
				<button onclick="backgroundColor()">
					<img src="/image/background.png" alt="Background Color" title="Background Color" >
				</button></a>
			</li>
			<li class='control_menu'><a>
				<button onclick="copy()">
					<img src="/image/copy.png" alt="Copy Object" title="Copy Object" >
				</button></a> 
			</li>
			<li class='control_menu'><a>
				<button onclick="paste()">
					<img src="/image/paste.png" alt="Paste Object" title="Paste Object" >
				</button></a> 
			</li>		
			<li class='control_menu'><a>
				<button onclick="up()">
					<img src="/image/up.png" alt="Up Layer" title="Up Layer" >
				</button></a> 
			</li>
			<li class='control_menu'><a>
				<button onclick="down()">
					<img src="/image/down.png" alt="Down Layer" title="Down Layer" >
				</button></a> 
			</li>		
			<li class='control_menu'><a>
				<button onclick="undo()">
					<img src="/image/undo.png" alt="Undo" title="Undo" >
				</button></a> 
			</li>
			<li class='control_menu'><a>
				<button onclick="redo()">
					<img src="/image/redo.png" alt="Redo" title="Redo" >
				</button></a> 
			</li>	
			<li class='control_menu'><a>
				<button onclick="save()">
					<img src="/image/backup.png" alt="Backup" title="Backup" >
				</button></a> 
			</li>
			<li class='control_menu'><a>
				<button onclick="restore()">
					<img src="/image/restore.png" alt="Restore" title="Restore" >
				</button></a> 
			</li>					
			<li class='control_menu'><a>
				<button onclick="download()">
					<img src="/image/download.png" alt="Download" title="Download" >
				</button></a>
			<li class='control_menu'><a>
				<button onclick="openPopup('youtubeLinker')" >
					<img src="/image/YouTube.png" alt="YouTube" title="YouTube" height="35" width="35">
				</button></a>
			</li>
			<li class='control_menu'><a>
				<button id="btnZoomIn">
					<img src="/image/magnifier2.png" alt="Zoom In" title="Zoom In" >
				</button></a> 
			</li>
			<li class='control_menu'><a>
				<button id="btnZoomOut">
					<img src="/image/magnifier1.png" alt="Zoom Out" title="Zoom Out" >
				</button></a> 
			</li>
			<li class='control_menu'><a>
				<button id="btnResetZoom">
					<img src="/image/magnifier3.png" alt="Reset Zoom" title="Reset Zoom" >
				</button></a> 
			</li>
			<%if(user.local.username==host){ %>
				<li class='control_menu'><a>
					<button id="Close" onclick="closeRoom()">
						<img src="/image/exit.png" alt="Close Room" title="Close Room">
					</button></a> 
				</li>
				<li class='control_menu' style="float:right"><a>
					<input type="image" id="updateButton" value="Disable Edit" src="/image/green.png"  alt="Enabling Edit" title="Enabling Edit" onClick="disable_edit();">
					</a>
				</li>
				<script>
					function disable_edit(){
						var image = document.getElementById("updateButton");
						if (image.src.match("green")){
							image.src = "/image/red.png";
							image.alt = "Disabling Edit";
							image.title= "Disabling Edit";
						} else {
							image.src = "/image/green.png";
							image.alt = "Enabling Edit";
							image.title= "Enabling Edit";						
						}
					}
				</script>
			<%}else{%>
					<input type="image" src="/image/green.png" id="updateMessage" alt="Editable" title="Editable" value="Editable" disabled>
			<%}%>
			</li>
		</ul>
	</div>
	
		<div class='content'>
				<button id="toggle_menu" style="float:left; z-index:9999999999999999999999;" onClick="toggle_menu()";>
				Hide Menu
				</button>
				<button id="toggle_chat" style="float:left; z-index:9999999999999999999999;" onClick="toggle_chat()";>
				Hide Chat
				</button>
				<script>
					function toggle_menu(){
						if ($("#control").is(":hidden")){
							$("#control").slideDown(200);
							$("#toggle_menu").html("Hide Menu");
							$(".content").animate({height:"85%"},200);
							$(".sidebar2").animate({height:"85%"},200);
							//setTimeout(function(){scrollObj.resize();}, 210);
						}
						else{
							$("#control").slideUp(200);
							$("#toggle_menu").html("Show Menu");
							$(".content").animate({height:"95%"},200);
							$(".sidebar2").animate({height:"95%"},200);
							//setTimeout(function(){scrollObj.resize();}, 210);
						}
					}
					function toggle_chat(){
						if ($(".sidebar2").is(":hidden")){
							$(".sidebar2").show('slide', {direction: "right"},200);
							$("#toggle_chat").html("Hide Chat");
							$(".content").animate({width:"75%"},200);
							//setTimeout(function(){scrollObj.resize();}, 210);
						} else{
							$(".sidebar2").hide('slide', {direction: "right"},200);
							$("#toggle_chat").html("Display Chat");	
							$(".content").animate({width:"100%"},200);
							//setTimeout(function(){scrollObj.resize();}, 210);
						}
					}
				</script>
				
				<div id="show_status">
					<a href="#">
						<b>Room Status</b>
					</a>
				</div>
				
				<div id="container">
			
					<!--   <canvas id="whiteboardCanvas" width="800" height="100%"></canvas> -->
					<canvas id="whiteboardCanvas" width="2000" height="2000" >
					</canvas>
					<!--    <canvas id="bottomCanvas" width="800" height="600" 
					style="position: absolute; left: 0; top: 0; z-index: -1; background-color:white; "></canvas>  -->
					<!-- background-color:red; -->
				</div>		
			</div>
	
		<!-- Chatroom -->  
		<div id="right" class="sidebar2">
			<div id='chat_info' style="width: 90%; display: block; overflow: auto" >
				<p id="welcome" align="left" style="display:inline; font-size: 14px;"><b>Greetings, <%= user.local.username %>!</b>
							<audio id="audio" style="float: right;" autoplay muted></audio>
							<img src="image/record.png" height="25" width="25" id="record-audio" style="float:right"/>
							
<!-- 					<button id="record-audio">Record</button>
					<button id="stop-recording-audio" disabled>Stop</button> -->
				</p>
			</div>
			<div id="conversation"></div>
			<textarea rows="3" id="data" autofocus="autofocus"/></textarea>
		</div>


<!-- Pop Up Edit Text-->
	  
	<div id="texteditor2" class="popup draggable">
		<div class="cancel" onclick="closePopup('texteditor2')">
			<img src="/image/closewin.png" alt="Close" title="close" height="15" width="15">
		</div>
		<b style="font-size:12pt; color:#000000"> Edit Text Object </b>
		<ul>
			<li>
				Text: <input id="textBox2" placeholder="Insert text here" />
			</li>
			<li>
				Font: <select id="textFont2">
				<option value="serif">serif</option>
				<option value="sans-serif">sans-serif</option>
				<option value="cursive">cursive</option>
				<option value="fantasy">fantasy</option>
				<option value="monospace">monospace</option>
				</select>
			</li>	
			<li>
				Weight:
				<select id="fontWeight2">
				<option value="normal">normal</option>
				<option value="bold">bold</option>
				<option value="bolder">bolder</option>
				<option value="lighter">lighter</option>
				</select>
			</li>
			<li>
				Style:
				<select id="fontStyle2">
				<option value="normal">normal</option>
				<option value="italic">italic</option>
				<option value="oblique">oblique</option>
				</select>
			</li>
			<li>
				Text Size: 				
				<input class="slider" type="range" id="textSize2"
				min="1"
				max="200"
				step="1"
				value="30"
				oninput="textSizeChanged2(this.value);"
				onchange="textSizeChanged2(this.value); changeDone();">
			</li>
		</ul>
	</div>

	<!-- POPUP TEXT EDITOR -->
	<div id="youtubeLinker" class="popup draggable">
		<div class="cancel" onclick="closePopup('youtubeLinker')">
			<img src="/image/closewin.png" alt="Close" title="close" height="15" width="15">
		</div>
		<b style="font-size:12pt; color:#000000"> Youtube Player </b>
		<ul>
			<li>
				Link: <input id="youtubeLink" style="width: 250px;" placeholder="Insert link here" 
				onkeyup="$('#youtubeButton').attr('title', this.value);"/>
				<button id="youtubeButton" class="youtube" title="http://youtu.be/e-zw2EV2_Oc">Open</button>
				<button id="youtubeButton2" class="youtube" title="" hidden></button>
			</li>
		</ul>
	</div>
	
<!-- POPUP TEXT EDITOR -->
	<div id="texteditor" class="popup draggable">
		<div class="cancel" onclick="closePopup('texteditor')">
			<img src="/image/closewin.png" alt="Close" title="close" height="15" width="15">
		</div>
		<b style="font-size:12pt; color:#000000"> Text Editor </b>
		<ul>
			<li>
				Text: <input id="textBox" placeholder="Insert text here" />
			</li>
			<li>
				Font: <select id="textFont">
				<option value="serif">serif</option>
				<option value="sans-serif">sans-serif</option>
				<option value="cursive">cursive</option>
				<option value="fantasy">fantasy</option>
				<option value="monospace">monospace</option>
				</select>
			</li>	
			<li>
				Weight:
				<select id="fontWeight">
				<option value="normal">normal</option>
				<option value="bold">bold</option>
				<option value="bolder">bolder</option>
				<option value="lighter">lighter</option>
				</select>
			</li>
			<li>
				Style:
				<select id="fontStyle">
				<option value="normal">normal</option>
				<option value="italic">italic</option>
				<option value="oblique">oblique</option>
				</select>
			</li>
			<li>
				Text Size: 
				<input class="slider" type="range" id="textSize"
				min="0"
				max="200"
				step="1"
				value="30">
			</li>
		</ul>
	</div>
	

<!-- POPUP Image Uploader-->
	<div id="imageuploader" class="popup draggable">
		<div class="cancel" onClick="closePopup('imageuploader')">
			<img src="/image/closewin.png" alt="Close" title="Close" height="15" width="15">
		</div>
		<b style="font-size:12pt; color:#000000"> Image Uploader </b>
			<ul>
				<li>
					<input type="radio" name="imagesource" value="1" onClick="setImage(1);">
					<b>Upload a local image:</b>
					<input id="inputFileToLoad" type="file" accept="image/png, image/gif, image/jpeg" onchange="loadImageFileAsURL();" />
				</li>
				<li>
					<label>
					<input type="radio" name="imagesource" value="2" onClick="setImage(2);"> 
					<b>Image URL:</b> 
					<input id="inputURLToLoad" placeholder="" onKeyUp="setURL(this.value);"/> 
					<span id="urlMessage"></span>
					</label>
				</li>
			</ul>
	</div>  
	
	<div id="imageuploader2" class="popup draggable">
		<div class="cancel" onClick="closePopup('imageuploader2')">
			<img src="/image/closewin.png" alt="Close" title="Close" height="15" width="15">
		</div>
		<b style="font-size:12pt; color:#000000"> Post Math Formula by Tex </b>
			<ul>
				<li>
					<table><tr>
					<td><textarea id="inputLatexToLoad" rows="3" cols="30" onKeyUp="setLatex(this.value);"></textarea></td>
					<td>Preview:</br>
					<img id="latexImage" src="https://chart.googleapis.com/chart?cht=tx&chl=x=\frac{(1%2By)}{1%2B2z^2}&chf=bg,s,0000EF00"></img></td>
					</tr></table>
				</li>
			</ul>
	</div>  
	
<!-- hover Popup status -->
	<div id='status'>
		Room ID: <%= room %>
		<ul>
			<li> Host: <%= host%> </li>
		</ul>
	</div>

<!-- Adjustment-->
<div id="adjust" class="draggable">
	<div id="customwidget" style="float:left; margin:5px">
		<div id="colorSelector">
			<div style="background-color: #000000;">
			</div>
		</div>
	</div>
	<div id="strokefill" style="float: left; margin-top: 10px; margin-left:10px">
		
		<select onChange="setStyle(this.options[this.options.selectedIndex].value);">
			<option value="1" name="style">Stroke</option>
			<option value="2" name="style">Fill</option>
		</select>
	</div>
	<div id="thickness" style="float: left; margin-top: 12px; margin-left:10px;">
		<b>Thickness:</b>
	</div>
	<div id="sizebar" style="float: left; margin-top: 12px; margin-left:10px;">
		<input class="slider" type="range" id="textSize3"
		min="1"
		max="20"
		step="1"
		value="1"
		oninput="setWidth(this.value);"
		onchange="setWidth(this.value); changeDone();">
	</div>
</div>
	
	
	
	<div id='enter_room'>
		<h1>ENTER ROOM</h1>
	</div>
	
	<div id='close_room'>
		<h1>Room Closing...</h1>
	</div>
	
 <script>
    var client = new Whiteboard('whiteboardCanvas');
	client.connect();
	client.username = "<%=user.local.username%>";
	client.room = "<%= room %>";
	waitForSocketConnection(client.socket, function(){
        client.socket.send(JSON.stringify({ 
			msg: 'enterRoom' ,
			data: {
				username: client.username,
				room: client.room,
				date: new Date()
			}
		}));	
		$("#enter_room").fadeIn(500);
		$("#enter_room").delay(1000).fadeOut(500);
    });
	
	function waitForSocketConnection(socket, callback){
    setTimeout(
        function () {
            if (socket.readyState === 1) {
                //console.log("Connection is made")
                if(callback != null){
                    callback();
                }
                return;

            } else {
                //console.log("wait for connection...")
                waitForSocketConnection(socket, callback);
            }

        }, 5); // wait 5 milisecond for the connection...
	}
	
	var zoomed = false;
	$("#edittext").prop("disabled", true); 

	client.autoUpdate=1;
	var updateButton = document.getElementById( "updateButton" );
	if(updateButton)
		updateButton.addEventListener( "click", updateEvent, false );
	
	var host = "<%= host %>";
	
	function updateEvent(e) {
		if ( client.autoUpdate ) {
			updateButton.value = "Enable Edit";
			client.autoUpdate = null;
			client.socket.send(JSON.stringify({
				msg: 'disable',
				data: {
					host: host
				}
			}));	
		} else {
			updateButton.value = "Disable Edit";
			client.autoUpdate = 1;
			client.socket.send(JSON.stringify({
				msg: 'enable',
				data: {
					host: <%= host %>
				}
			}));	
		}
	}
	
	function datasend() {
		var message = $('#data').val().replace(/\r\n|\r|\n/g,"<br />");
		$('#data').val('');
		// tell server to execute 'sendchat' and send along one parameter
		client.socket.send(JSON.stringify({
			msg: 'conversation',
			data: {
				username: client.username,
				type: 'text',
				message: message,
				date: new Date()
			}
		}));
		$('#conversation').append('<b>'+client.username + ':</b> ' + message + '<br>');	
		var objDiv = document.getElementById("conversation");
		objDiv.scrollTop = objDiv.scrollHeight;			
	}
	
	//$("#txtChatMessage").keydown(MessageTextOnKeyEnter);
	$('#data').keydown(function(e) {
		if (e.keyCode == 13) {
			if (e.shiftKey) {
				var val = this.value;
				if (typeof this.selectionStart == "number" && typeof this.selectionEnd == "number") {
					var start = this.selectionStart;
					this.value = val.slice(0, start) + "\n" + val.slice(this.selectionEnd);
					this.selectionStart = this.selectionEnd = start + 1;
				} else if (document.selection && document.selection.createRange) {
					this.focus();
					var range = document.selection.createRange();
					range.text = "\r\n";
					range.collapse(false);
					range.select();
				}
			}
			else{
				if(!($('#data').val()=="")){
					$(this).blur();
					datasend();
					document.getElementById("data").focus();
				}
			}
			return false;
		}
/*		if(e.which == 13) {
			console.log(e);
			if(!($('#data').val()=="")){
				$(this).blur();
				datasend();
				document.getElementById("data").focus();
			}
		}*/
	});

/*	client.username = prompt("Please enter your name");
	
	client.socket.send(JSON.stringify({
		msg: 'adduser',
		data: client.username
	}));*/
	
	var localImage = null;
	var urlImage = null;
	var that = client;
	document.onpaste = function(event){
	//function onPaste(event){
		try{
			var items = (event.clipboardData || event.originalEvent.clipboardData).items;
			console.log(JSON.stringify(items)); // will give you the mime types
			for(var i=0;i<items.length;i++)
				if (items[i].type.indexOf("image") != -1){
					if (confirm('Are you sure to paste image?')) {
						var blob = items[i].getAsFile();
						var reader = new FileReader();
						reader.onload = function(event){
							//console.log(event.target.result);
							var x = 0;
		                    var y = 0;
							var imgObj = new Image();
							//imgObj.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9sMEQ4oKYwJgHsAAAMoSURBVFjD7ZZRaFtVGMd/5+a0ubkmS7tlXbuYblpa1zGyqV1pgy9OkKFjyvDFF/smccoQxrQMQQoTdPqisBFBQcUhIvomCEWGD40owrayTtdsa1NY0jRL0iWkub25uceXFoXV2qzL9tI/fHC53Pv9f9855/s4sKENPWCJlV4qpdadOBrR3QJGNEHuzJj5IYAQd9ppjagqGtG9An7ZpIvjQvDyat9qDTDfAvy+79HAPr9Hq9oO39w3gGhEDwEX9u/p7n7qyd3uVMkFcO6+AEQjegBEPLy7J3jwiQ45dvUWtm2Nx+JmquEA0YhuAOcf6epuPxI2tPHkbf6anisDZ//vX+0emEvgx0DHju5De7zycmKGKzmJWco7wPcNBwC+9Afa+58Nb3WXM5NMmtuYz6ZNcD6Kxc1yQwGiEf0D76bNLwz2hozt9nUuzLooOh7y2VnHUXy8lhzaOszfcHu8r+/q6Xpo0J/kt6ky07UgqnhzUeCcjcXN2w2bhKdOHnsLVX2/GUsccI2RzaT5Nb+V7QE/lycmsrZDVyxulu4wW2ES1g0wMjKiGV795q7Hetttu6quJf4U1qXv2Oz3MXllfKGyaB2Kxc3zK1a7AoCsd+kNo/k5XXd7Djz9DKVSSSgHrqmXyF/61qrZ1tf/ZX7PzoCQrpP9fQP+pqYmpqamWFio0NYeVFrPQceq8Wa9+eoCOH36VC9K7Q2H95JOp8lkMrikpnK5WwXN7Xs8Fjcr9QLUtwWy6Xj//oFmTdNIJBIU5vNOLpctKKc6+Pbwu4m76aY1AUgpfcFg8JOdO3e8cvGPi1pyeoaKueAUS/N55VQHTpx453rDLiRCiC1tbW0/DQ0N9fn9fkZHR0kmkxx+8flCx7aH+4aHh2+s2azeLhBCSOAHKWVfKBSitbUVj8eDlJKvvjj3WaFQuLHeOb7qCgghzgBHfT4fnZ2dtLS0UC6XSaVSzM3NHQV+BhzAXooqYC3FolLKvutBJIR4Ffj0n/43MAwDy7IoFotp4DXAXCUqQFkpVasbADgGvLfMs1TlLDADTACfA4tAbanq5cqXn6v/Nl4NYEMbeuD6G2BFQviVGcVVAAAAAElFTkSuQmCC";
							imgObj.src = event.target.result;
							imgObj.onload = function () {
								// start fabricJS stuff
								console.log(imgObj.width,imgObj.height,that.canvas.width, that.canvas.height);
								
								var image = new fabric.Image(imgObj);
								image.set({
									left: x,
									top: y,
									originX: 'left',
									originY: 'top',
									id: that.auth+(that.i++)
								});
									
								if(imgObj.width>that.canvas.width)
									if(imgObj.width/(that.canvas.width-x) > imgObj.height/(that.canvas.height-y))
										image.set({
											width: that.canvas.width-x,
											height: (that.canvas.width-x)*(imgObj.height/imgObj.width)	
										});
									else
										image.set({
											width: (that.canvas.height-y)*(imgObj.width/imgObj.height),
											height: that.canvas.height-y
										});	
								else if(imgObj.height>that.canvas.height)
									if(imgObj.width/(that.canvas.width-x) < imgObj.height/(that.canvas.height-y))
										image.set({
											width: (that.canvas.height-y)*(imgObj.width/imgObj.height),
											height: that.canvas.height-y
										});	
									else
										image.set({
											width: that.canvas.width-x,
											height: (that.canvas.width-x)*(imgObj.height/imgObj.width)
										});		
								
								var center = image.getCenterPoint();
								image.set({
									originX: 'center',
									originY: 'center',
									left: center.x,
									top: center.y
								});
								
								if(that.idle==false)
									image.selectable = false;
								
								that.canvas2.add(image);
								//that.canvas2.sendToBack(image);
								that.canvas2.renderAll();
								that.canvas2.calcOffset(); 
								// end fabricJS stuff
								
								that.socket.send(JSON.stringify({
									msg: 'create',
									data: {
										type: 'image',
										id: image.id,
										x: image.left,
										y: image.top,
										src: event.target.result,
										width: image.width,
										height: image.height
									}
								}));
							}
						}; 
						reader.readAsDataURL(blob);
					}
				}
		}
		catch(e){
		
		}
	}
	
    function erase() {
		if(client.editable&&!zoomed){
			client.canvas2.isDrawingMode = false;
			if (confirm('Are you sure?')) {
				client.canvas2.clear();
				client.canvas2.backgroundColor='white';
				client.canvas2.renderAll();
				client.canvas2.calcOffset(); 	
				client.sendClear();
				var json = JSON.stringify(client.canvas2.toJSON(['id']));
				client.socket.send(JSON.stringify({
					msg: 'save',
					data: {
						json: json
					}
				}));
				client.removedImages = [];
				client.savedImages.push(client.currentImage);
				client.currentImage = json;				
			}
		}
    }
	
	function changeDone(){
		if(client.canvas2.getActiveObject()||client.canvas2.getActiveGroup()){
			var json = JSON.stringify(client.canvas2.toJSON(['id']));
			client.removedImages = [];
			client.savedImages.push(client.currentImage);
			client.currentImage = json;	
		}
	}
	
	function restore() {
		if(client.editable&&!zoomed){
			if (confirm('Are you sure to restore from local status?')) {
				client.canvas2.isDrawingMode = false;
				client.canvas2.off('mouse:up');
				client.canvas2.off('mouse:down');
				client.canvas2.off('mouse:move');
				var json = window.localStorage.getItem("hoge");
				loadCanvas(json);
			}
		}
    }
	
	function loadCanvas(json){
		client.currentImage = json;
		client.canvas2.loadFromJSON(json);
		// re-render the canvas
		client.idle=true;
		client.canvas2.selection = true;
		client.canvas2.forEachObject(function(o) {
			o.selectable = true;
			client.selectList[o.id][0] = true;
			client.selectList[o.id][1] = client.username;
		});
		
		client.canvas2.renderAll();
		client.canvas2.calcOffset();
		client.socket.send(JSON.stringify({
			msg: 'restore',
			data: {
				json: json
			}
		}));
		client.canvas2.forEachObject(function(o) {
			client.socket.send(JSON.stringify({
				msg: 'unselected',
				data: {
					id: o.id,
					user: client.username
				}
			}));
			client.selectList[o.id]=[true, client.username];
		});
		client.socket.send(JSON.stringify({
			msg: 'save',
			data: {
				json: json
			}
		}));		
		select();
	}
			
	function save() {
		//var json = JSON.stringify(client.canvas2);
		var json = JSON.stringify(client.canvas2.toJSON(['id']));
		//var json = JSON.stringify(client.canvas2);
		console.log(json);
		window.localStorage.setItem("hoge", json);
    }

	function down() {
		if(client.editable&&!zoomed){
			var activeObject = client.canvas2.getActiveObject();
			if (activeObject) {
				client.canvas2.sendBackwards(activeObject);
				client.canvas2.renderAll();
				client.canvas2.calcOffset();
				client.socket.send(JSON.stringify({
					msg: 'down',
					data: {
						id: activeObject.id
					}
				}));
				var json = JSON.stringify(client.canvas2.toJSON(['id']));
				client.socket.send(JSON.stringify({
					msg: 'save',
					data: {
						json: json
					}
				}));
				client.removedImages = [];
				client.savedImages.push(client.currentImage);
				client.currentImage = json;	
			}
		}
    }
			
	function up() {
		if(client.editable&&!zoomed){
			var activeObject = client.canvas2.getActiveObject();
			if (activeObject) {
				client.canvas2.bringForward(activeObject);
				client.canvas2.renderAll();
				client.canvas2.calcOffset();
				client.socket.send(JSON.stringify({
					msg: 'up',
					data: {
						id: activeObject.id
					}
				}));
				var json = JSON.stringify(client.canvas2.toJSON(['id']));
				client.socket.send(JSON.stringify({
					msg: 'save',
					data: {
						json: json
					}
				}));
				client.removedImages = [];
				client.savedImages.push(client.currentImage);
				client.currentImage = json;	
			}
		}
    }
	
	var copiedObject=null;
	var copiedObjects = new Array();
	
	function copy(){
		if(client.editable&&!zoomed){
			var activeObject = client.canvas2.getActiveObject(),
			activeGroup = client.canvas2.getActiveGroup();
			if(activeGroup){
				copiedObjects = new Array();
				for(var i in activeGroup.objects){
					var object = fabric.util.object.clone(client.canvas2.getActiveGroup().objects[i]);
					object.set("top", activeGroup.top+object.top+5);
					object.set("left", activeGroup.left+object.left+5);
					copiedObjects.push(object);
				}                    
			}
			else if(activeObject){
				var object = fabric.util.object.clone(activeObject);
				object.set("top", object.top+5);
				object.set("left", object.left+5);
				copiedObject = object;
				copiedObjects = new Array();
			}
		}
	}
	
	function paste(){
		if(client.editable&&!zoomed){
			var activeGroup = client.canvas2.getActiveGroup();
			if(activeGroup){
				var array = new Array();
				var objArray = client.canvas2.getObjects();
				for (var j = 0 ; j < objArray.length; j++) {
					array[j]=objArray[j].id;
				}
				client.socket.send(JSON.stringify({
					msg: 'groupCancel',
					data: {
						id: activeGroup.id,
						array: array,
						user: client.username
					}
				}));
				client.selectList[activeGroup.id]=[false, client.username];		
				for(var i =0;i< activeGroup._objects.length;i++){
					client.socket.send(JSON.stringify({
						msg: 'unselected',
						data: {
							id: activeGroup._objects[i].id,
							user: client.username
						}
					}));
				}
				client.canvas2.discardActiveGroup();
			}
			if(copiedObjects.length > 0){
				select();
				for(var i in copiedObjects){
					if(copiedObjects[i].type == 'image'){
						client.socket.send(JSON.stringify({
							msg: 'create',
							data: {
								type: 'image',
								id: (client.auth+(client.i)),
								x: copiedObjects[i].left,
								y: copiedObjects[i].top,
								src: copiedObjects[i].getSrc(),
								width: copiedObjects[i].width,
								height: copiedObjects[i].height,
								scaleX:	copiedObjects[i].scaleX,
								scaleY: copiedObjects[i].scaleY
							}
						}));
					}else{
						client.socket.send(JSON.stringify({
							msg: 'copy',
							data: {
								object: copiedObjects[i],
								id: (client.auth+(client.i))
							}
						}));
					}
					copiedObjects[i].id= client.auth+(client.i++);
					client.canvas2.add(copiedObjects[i]);
					client.socket.send(JSON.stringify({
						msg: 'unselected',
						data: {
							id: copiedObjects[i].id,
							user: client.username
						}
					}));
					client.selectList[copiedObjects[i].id]=[true, client.username];
					var object = fabric.util.object.clone(copiedObjects[i]);
					object.set("top", object.top+5);
					object.set("left", object.left+5);
					copiedObjects[i] = object;
				}                    
			}
			else if(copiedObject){
				select();
				if(copiedObject.type == 'image'){
					client.socket.send(JSON.stringify({
						msg: 'create',
						data: {
							type: 'image',
							id: (client.auth+(client.i)),
							x: copiedObject.left,
							y: copiedObject.top,
							src: copiedObject.getSrc(),
							width: copiedObject.width,
							height: copiedObject.height,
							scaleX:	copiedObject.scaleX,
							scaleY: copiedObject.scaleY
						}
					}));
				}else{
					client.socket.send(JSON.stringify({
						msg: 'copy',
						data: {
							object: copiedObject,
							id: (client.auth+(client.i))
						}
					}));
				}
				copiedObject.id= client.auth+(client.i++);
				console.log(copiedObject.id);
				client.canvas2.add(copiedObject);
				client.socket.send(JSON.stringify({
					msg: 'unselected',
					data: {
						id: copiedObject.id,
						user: client.username
					}
				}));
				client.selectList[copiedObject.id]=[true, client.username];
				var object = fabric.util.object.clone(copiedObject);
				object.set("top", object.top+5);
				object.set("left", object.left+5);
				copiedObject = object;
			}
			client.canvas2.renderAll(); 
			client.canvas2.calcOffset();	
			var json = JSON.stringify(client.canvas2.toJSON(['id']));
			client.socket.send(JSON.stringify({
				msg: 'save',
				data: {
					json: json
				}
			}));
			client.removedImages = [];
			client.savedImages.push(client.currentImage);
			client.currentImage = json;			
		}
	}
	
	function backgroundColor() {
		if(client.editable&&!zoomed){
			console.log(client.color);
			//client.canvas2.backgroundColor='red';
			client.canvas2.backgroundColor='rgb(' + client.color.r + "," + client.color.g + "," + client.color.b +')';
			client.canvas2.renderAll();
			client.socket.send(JSON.stringify({
				msg: 'bgColor',
				data: {
					color: client.color
				}
			}));
			var json = JSON.stringify(client.canvas2.toJSON(['id']));
			client.socket.send(JSON.stringify({
				msg: 'save',
				data: {
					json: json
				}
			}));
			client.removedImages = [];
			client.savedImages.push(client.currentImage);
			client.currentImage = json;	
		}
    }
    
    function setColor(r,g,b) {
      client.setColor(r,g,b);
    }
	
	function setWidth(width) {
      client.setWidth(width);
    }
	
	function setEdit(condition){
		if(condition==true){
			client.idle = true;
			client.canvas2.selection = true;
			client.canvas2.forEachObject(function(o) {
				if(client.selectList[o.id][1]==client.username){
					o.selectable = true;
					//console.log('yeah');
				}
				else{
					o.selectable = client.selectList[o.id][0];
					//console.log('oh...',o.selectable);
				}
			});
			console.log("able to edit now");
		}else{
			client.idle = false;
			client.canvas2.selection = false;
			client.canvas2.forEachObject(function(o) {
				o.selectable = false;
			});
		}
	}
	
	function select() {
		if(client.editable&&!zoomed){
			client.canvas2.isDrawingMode = false;
			client.canvas2.off('mouse:up');
			client.canvas2.off('mouse:down');
			client.canvas2.off('mouse:move');
			setEdit(true);
		}
    }
	
	function removeObject() {	
		if(client.editable&&!zoomed){
			var activeObject = client.canvas2.getActiveObject(),
			activeGroup = client.canvas2.getActiveGroup();
			console.log(activeObject,activeGroup);
			if (activeObject) {
				if (confirm('Are you sure?')) {
					client.socket.send(JSON.stringify({
						msg: 'remove',
						data: {
							id: activeObject.id
						}
					}));	
					client.canvas2.remove(activeObject);
					var json = JSON.stringify(client.canvas2.toJSON(['id']));
					client.socket.send(JSON.stringify({
						msg: 'save',
						data: {
							json: json
						}
					}));
					client.removedImages = [];
					client.savedImages.push(client.currentImage);
					client.currentImage = json;		
				}
			}
			else if (activeGroup) {
				console.log('group removing..', activeGroup.id);
				if (confirm('Are you sure?')) {
					console.log('group removing..', activeGroup.id);
					client.socket.send(JSON.stringify({
						msg: 'remove',
						data: {
							id: activeGroup.id
						}
					}));	
					var objectsInGroup = activeGroup.getObjects();
					client.canvas2.discardActiveGroup();
					objectsInGroup.forEach(function(object) {
						client.canvas2.remove(object);
					});
					var json = JSON.stringify(client.canvas2.toJSON(['id']));
					client.socket.send(JSON.stringify({
						msg: 'save',
						data: {
							json: json
						}
					}));
					client.removedImages = [];
					client.savedImages.push(client.currentImage);
					client.currentImage = json;		
				}
			}
			client.canvas2.isDrawingMode = false;
			client.canvas2.off('mouse:up');
			client.canvas2.off('mouse:down');
			client.canvas2.off('mouse:move');
			setEdit(true);
			client.canvas2.renderAll();
			client.canvas2.calcOffset(); 
		}
	}
	
	function setFunc(command) {
		if(client.editable&&!zoomed){
			client.canvas2.isDrawingMode = false;
			client.canvas2.off('mouse:up');
			client.canvas2.off('mouse:down');
			client.canvas2.off('mouse:move');
			setEdit(false);
			if(command=='draw')
				client.draw();
			if(command=='drawRect')
				client.rect();
			if(command=='drawSquare')
				client.square();
			if(command=='drawLine')
				client.line();
			if(command=='drawCircle')
				client.circle();
			if(command=='drawOval')
				client.ellipse();
			if(command=='text')
				client.text();
			if(command=='image')
				client.image();
			if(command=='latex')
				client.latex();
			client.setFunc(command);
		}
    }
	
	function setImage(source) {
		if(source==1)
			client.setImage(localImage);
		else if(source==2)
			client.setImage(urlImage);
	}
	
	function setStyle(source) {
		if(source==1)
			client.setStyle(1);
		else if(source==2)
			client.setStyle(2);
	}

	function download() {
		//var json = client.canvas2.toJSON(['id']);
		//console.log(json);
		var base64 = client.canvas2.toDataURL("png");

		var image = new Image();
		image.onload = function() {
			//var url = image.src.replace(/^data:image\/[^;]/, 'data:application/octet-stream');
			//location.href = url;
			window.open(image.src);
		}
		image.src = base64;
	}

	function CanvasSaver(url) {
	   this.url = url;
	   this.savePNG = function(cnvs, fname) {
	   if(!cnvs || !url) return;
		 fname = fname || 'picture';

		 var data = cnvs.toDataURL("image/png");
		 data = data.substr(data.indexOf(',') + 1).toString();
		 var dataInput = document.createElement("input") ;
		 dataInput.setAttribute("name", 'imgdata') ;
		 dataInput.setAttribute("value", data);

		 var nameInput = document.createElement("input") ;
		 nameInput.setAttribute("name", 'name') ;
		 nameInput.setAttribute("value", fname + '.png');

		 var myForm = document.createElement("form");
		 myForm.method = 'post';
		 myForm.action = url;
		 myForm.appendChild(dataInput);
		 myForm.appendChild(nameInput);

		 document.body.appendChild(myForm) ;
		 myForm.submit() ;
		 document.body.removeChild(myForm) ;
	   };
	}

	function getRadioValue() {
		var inputs = document.getElementsByName("imagesource");
		for (var i = 0; i < inputs.length; i++) {
		  if (inputs[i].checked) {
			return inputs[i].value;
		  }
		}
	}
	
	function loadImageFileAsURL()
	{
		var fileExtension = "";
		var fileElement = document.getElementById("inputFileToLoad");
		var filesSelected = fileElement.files;
        if (fileElement.value.lastIndexOf(".") > 0) {
            fileExtension = fileElement.value.substring(fileElement.value.lastIndexOf(".") + 1, fileElement.value.length);
        }
        if (fileExtension == "gif"||fileExtension == "jpg"||fileExtension == "jpeg"||fileExtension == "png") {
			if (filesSelected.length > 0)
			{
				var fileToLoad = filesSelected[0];

				var fileReader = new FileReader();

				fileReader.onload = function(fileLoadedEvent) 
				{
					localImage = fileLoadedEvent.target.result;
					if(getRadioValue()==1)
						client.setImage(localImage);
				};
				fileReader.readAsDataURL(fileToLoad);
			}
        }
        else {
            alert("You must select an image file for upload");
        }
	}
	//onKeyDown="callname1(this.value);" onKeyPress="callname1(this.value);" onKeyUp="callname1(this.value);"></textarea>

    function setLatex(str) {
		var latex = str.replace(/\+/g,"%2B");;
        url = 'https://chart.googleapis.com/chart?cht=tx&chl='+latex+'&chf=bg,s,00000000';
		$("#latexImage").attr("src",url);
		client.setLatex(url);
	}
	
    function setURL(str) {
		/*$('#urlMessage').html('Loading...');	
		client.socket.send(JSON.stringify({
			msg: 'url',
			data: {
				url: str
			}
		}));*/
		var img = new Image();
		img.crossorigin = "anonymous";

		img.onload = function() {
			$('#urlMessage').html('Loading...');	
			client.socket.send(JSON.stringify({
				msg: 'url',
				data: {
					url: str
				}
			}));
		}

		img.src = str;
		// make sure the load event fires for cached images too		*/
    }
	
	var SCALE_FACTOR = 1.2;
	
	$("#btnZoomIn").click(function(){
		zoomIn();
	});
	// button Zoom Out
	$("#btnZoomOut").click(function(){
		zoomOut();
	});
	// button Reset Zoom
	$("#btnResetZoom").click(function(){
		resetZoom();
	});

	createListenersKeyboard();

	function createListenersKeyboard() {
		document.onkeydown = onKeyDownHandler;
		//document.onkeyup = onKeyUpHandler;
	}

	function onKeyDownHandler(event) {
		//event.preventDefault();
		
		var key;
		if(window.event){
			key = window.event.keyCode;
		}
		else{
			key = event.keyCode;
		}
		
		switch(key){
			//////////////
			// Shortcuts
			//////////////
/*			case 86: // Ctrl+V
				if(ableToShortcut()){
					if(event.ctrlKey){
						event.preventDefault();
						onPaste(event);
						
					}
				}
				break;  */
			// Zoom In (Ctrl+"+")
			case 187: // Ctrl+"+"
				if(ableToShortcut()){
					if(event.ctrlKey){
						event.preventDefault();
						zoomIn();
					}
				}
				break;    
			// Zoom Out (Ctrl+"-")
			case 189: // Ctrl+"-"
				if(ableToShortcut()){
					if(event.ctrlKey){
						event.preventDefault();
						zoomOut();
					}
				}
				break;  
			// Reset Zoom (Ctrl+"0")
			case 48: // Ctrl+"0"
				if(ableToShortcut()){
					if(event.ctrlKey){
						event.preventDefault();
						resetZoom();
					}
				}
				break;            
			default:
				// TODO
				break;
		}
	}


	function ableToShortcut(){
		/*
		TODO check all cases for this
		
		if($("textarea").is(":focus")){
			return false;
		}
		if($(":text").is(":focus")){
			return false;
		}
		*/
		return true;
	}

	function enable () {
		zoomed = false;	
		if(client.editatable){
			client.idle = true;
			client.canvas2.selection = true;
			client.canvas2.forEachObject(function(o) {
				o.selectable = true;
			});
		}
	}

	function disable () {
		client.idle = false;
		zoomed = true;
		client.canvas2.selection = false;
		client.canvas2.forEachObject(function(o) {
			o.selectable = false;
		});
		client.canvas2.isDrawingMode = false;
		client.canvas2.off('mouse:up');
		client.canvas2.off('mouse:down');
		client.canvas2.off('mouse:move');
	}
	
	// Zoom In
	function zoomIn() {
	   // limiting the canvas zoom scale 
		if(client.canvasScale < 2.9)
		 {
			disable();
			client.canvas2.deactivateAllWithDispatch();
			//client.disable();
			client.canvasScale = client.canvasScale * SCALE_FACTOR;
			
			client.canvas2.setHeight(client.canvas2.getHeight() * SCALE_FACTOR);
			client.canvas2.setWidth(client.canvas2.getWidth() * SCALE_FACTOR);
			
			var objects = client.canvas2.getObjects();
			for (var i in objects) {
				var scaleX = objects[i].scaleX;
				var scaleY = objects[i].scaleY;
				var left = objects[i].left;
				var top = objects[i].top;
				
				var tempScaleX = scaleX * SCALE_FACTOR;
				var tempScaleY = scaleY * SCALE_FACTOR;
				var tempLeft = left * SCALE_FACTOR;
				var tempTop = top * SCALE_FACTOR;
				
				objects[i].scaleX = tempScaleX;
				objects[i].scaleY = tempScaleY;
				objects[i].left = tempLeft;
				objects[i].top = tempTop;
				
				objects[i].setCoords();
			}
				
			client.canvas2.renderAll();
			client.canvas2.calcOffset();
			//scrollObj.resize();
		}
	}

	// Zoom Out
	function zoomOut() {
		// limiting the zoom out scale 
		if(client.canvasScale > 0.45)
		{
			//zoomed = true;
			disable();
			client.canvas2.deactivateAllWithDispatch();
			client.canvasScale = client.canvasScale / SCALE_FACTOR;
			
			client.canvas2.setHeight(client.canvas2.getHeight() * (1 / SCALE_FACTOR));
			client.canvas2.setWidth(client.canvas2.getWidth() * (1 / SCALE_FACTOR));
			
			var objects = client.canvas2.getObjects();
			for (var i in objects) {
				var scaleX = objects[i].scaleX;
				var scaleY = objects[i].scaleY;
				var left = objects[i].left;
				var top = objects[i].top;
			
				var tempScaleX = scaleX * (1 / SCALE_FACTOR);
				var tempScaleY = scaleY * (1 / SCALE_FACTOR);
				var tempLeft = left * (1 / SCALE_FACTOR);
				var tempTop = top * (1 / SCALE_FACTOR);
		
				objects[i].scaleX = tempScaleX;
				objects[i].scaleY = tempScaleY;
				objects[i].left = tempLeft;
				objects[i].top = tempTop;
		
				objects[i].setCoords();
			}
			
			client.canvas2.renderAll();  
			client.canvas2.calcOffset();
			//scrollObj.resize();
		}    
	}

	// Reset Zoom
	function resetZoom() {
		//zoomed = false;
		enable();
		select();
		
		client.canvas2.setHeight(client.canvas2.getHeight() * (1 / client.canvasScale));
		client.canvas2.setWidth(client.canvas2.getWidth() * (1 / client.canvasScale));
		
		var objects = client.canvas2.getObjects();
		for (var i in objects) {
			var scaleX = objects[i].scaleX;
			var scaleY = objects[i].scaleY;
			var left = objects[i].left;
			var top = objects[i].top;
		
			var tempScaleX = scaleX * (1 / client.canvasScale);
			var tempScaleY = scaleY * (1 / client.canvasScale);
			var tempLeft = left * (1 / client.canvasScale);
			var tempTop = top * (1 / client.canvasScale);

			objects[i].scaleX = tempScaleX;
			objects[i].scaleY = tempScaleY;
			objects[i].left = tempLeft;
			objects[i].top = tempTop;

			objects[i].setCoords();
		}
			
		client.canvas2.renderAll();
		client.canvas2.calcOffset();
		//scrollObj.resize();
		client.canvasScale = 1;
	}

	//select();
	
	fabric.util.addListener(document.getElementById('container'), 'scroll', function () {
		console.log('scroll');
		client.canvas2.calcOffset();
	});
	
	function textSizeChanged2(value) {
		var activeObject = client.canvas2.getActiveObject();
		if (activeObject) {
			if(activeObject.type=='text'){
				activeObject.fontSize = value;
				activeObject.setCoords();
				client.canvas2.renderAll();
				client.canvas2.calcOffset();
				var json = JSON.stringify(client.canvas2.toJSON(['id']));
				client.socket.send(JSON.stringify({
					msg: 'save',
					data: {
						json: json
					}
				}));
			}
			client.socket.send(JSON.stringify({
				msg: 'editFontSize',
				data: {
					id: activeObject.id,
					fontSize: activeObject.fontSize
				}
			}));	
		}
	};
	
	client.canvas2.renderAll();
	client.canvas2.calcOffset();
	
	function undo(){
		if(client.editable&&!zoomed&&client.savedImages.length!=0){
			console.log('undo!');
			client.canvas2.isDrawingMode = false;
			client.canvas2.off('mouse:up');
			client.canvas2.off('mouse:down');
			client.canvas2.off('mouse:move');
			client.removedImages.push(JSON.stringify(client.canvas2.toJSON(['id'])));
			var saved = client.savedImages.pop();
			loadCanvas(saved);
			//.canvas2.loadFromJSON(saved);
/*		connections.forEach(function(destination) {
			destination.sendUTF(JSON.stringify({
				msg: 'image',
				data: {
					imageBase64: saved,
					points: [
						0,
						0
					]
				}
			}));
		});*/
		}
	}
				
	function redo(){
		if(client.editable&&!zoomed&&client.removedImages.length!=0){
			console.log('redo!');
			client.canvas2.isDrawingMode = false;
			client.canvas2.off('mouse:up');
			client.canvas2.off('mouse:down');
			client.canvas2.off('mouse:move');
			client.savedImages.push(JSON.stringify(client.canvas2.toJSON(['id'])));
			var saved = client.removedImages.pop();
			loadCanvas(saved);
			//client.canvas2.loadFromJSON(saved);
	/*		connections.forEach(function(destination) {
				connection.sendUTF(JSON.stringify({
					msg: 'image',
					data: {
						imageBase64: saved,
						points: [
							0,
							0
						]
					}
				}));
			});*/
		}
	}
	
	soundManager.setup({
	  // path to directory containing SM2 SWF
	  url: './360player/swf/'
	});

   function getByID(id) {
		return document.getElementById(id);
	}

	var recordAudio = getByID('record-audio');
		//stopRecordingAudio = getByID('stop-recording-audio');
		
	var audio = getByID('audio');

	var audioConstraints = {
		audio: true,
		video: false
	};
	
	var audioStream;
	var recorder;
	var recording = false;
	recordAudio.onclick = function() {
		if(!recording){
			if (!audioStream)
				navigator.getUserMedia(audioConstraints, function(stream) {
					if (window.IsChrome) stream = new window.MediaStream(stream.getAudioTracks());
					audioStream = stream;

					audio.src = URL.createObjectURL(audioStream);
					audio.play();

					// "audio" is a default type
					recorder = window.RecordRTC(stream, {
						type: 'audio'
					});
					recorder.startRecording();
				}, function() {
				});
			else {
				audio.src = URL.createObjectURL(audioStream);
				audio.play();
				if (recorder) recorder.startRecording();
			}

			window.isAudio = true;
	
			recordAudio.src = "/image/stop.png";
			recording=true;
			//this.disabled = true;
			//stopRecordingAudio.disabled = false;
		}
		else{
			//this.disabled = true;
			//recordAudio.disabled = false;
			audio.src = '';
			recordAudio.src = "/image/record.png";
			recording=false;
			if (recorder)
				recorder.stopRecording(function(url) {
					console.log(url);
					recorder.getDataURL(function(dataURL){
						client.socket.send(JSON.stringify({
							msg: 'conversation',
							data: {
								username: client.username,
								type: 'audio',
								message: dataURL,
								date: new Date()
							}
						}));
						var message = dataURL;
						//<div class="sm2-360ui"><canvas class="sm2-canvas" width="50" height="50"></canvas> <span class="sm2-360btn sm2-360btn-default"></span> <div class="sm2-timing alignTweak">0</div> <div class="sm2-cover"></div></div>
						var random = Math.random()*0xffffffff+"";
						$('#conversation').append('<b>'+client.username + '(Audio):</b> <div class="ui360" id ="'+random+'"><a href="'+ message +'"></a></div>');	
						threeSixtyPlayer.init(random);
						var objDiv = document.getElementById("conversation");
						objDiv.scrollTop = objDiv.scrollHeight;		
					});
				});
		}
	};
	
	function closeRoom(){
		client.socket.send(JSON.stringify({
			msg: 'roomClose'
		}));
		
		var form = document.createElement("form");
		form.setAttribute("method", "POST");
		form.setAttribute("action", "closeroom");

		var hiddenField = document.createElement("input");
		hiddenField.setAttribute("type", "hidden");
		hiddenField.setAttribute("name", "id");
		hiddenField.setAttribute("value", "<%= room %>");

		form.appendChild(hiddenField);

		document.body.appendChild(form);
		form.submit();
	}
	
	var player;
	var autoUpdate = null;
	var time;
	
	$("#youtubeButton").click(function(){
		var url = document.getElementById('youtubeButton').title;
		client.seeking = 0;
		client.playing = true;
		console.log(url);
		client.socket.send(JSON.stringify({
			msg: 'openYoutube',
			data: {
				username: client.username,
				url: url
			}
		}));
	});
	
	$(function () {
		$("button.youtube").YouTubePopup();
	});
	
	function onPlayerReady(event) {
		notControlled = false;
		//player.seekTo(seeking,true);
		if(client.playing)
			event.target.playVideo();
		else
			event.target.stopVideo();
		//console.log(seeking);
		notControlled = true;
	}

	// 5. The API calls this function when the player's state changes.
	//    The function indicates that when playing a video (state=1),
	//    the player should play for six seconds and then stop.

	var notControlled=true;
	function checkSeek(){
		var now = new Date();
		//console.log((player.getCurrentTime()-seeking)-((now-time)/1000));
		if((player.getCurrentTime()-client.seeking)<0||((player.getCurrentTime()-client.seeking)-((now-time)/1000))>3.0){
			console.log("seek!");
			client.seeking = player.getCurrentTime();
			client.socket.send(JSON.stringify({
				msg: 'seekYoutube',
				data:{
					time: player.getCurrentTime()
				}
			}));
		}
	}
	
	function onPlayerStateChange(event) {
		console.log(event);
		if(event.data==1){
			if(notControlled){
				console.log("Video Play");
				client.socket.send(JSON.stringify({
					msg: 'playYoutube'
				}));
				autoUpdate = setInterval( checkSeek, 1000 );
				time = new Date();
				client.seeking = player.getCurrentTime();
			}
		}
		if(event.data==2){
			if(notControlled){
				console.log("Video Stop");
				client.socket.send(JSON.stringify({
					msg: 'stopYoutube'
				}));
				clearInterval( autoUpdate );
				autoUpdate = null;
			}
		}
		if(event.data==3){
			if(notControlled){
				console.log("Jump to: ", player.getCurrentTime());
				client.seeking = player.getCurrentTime();
				client.socket.send(JSON.stringify({
					msg: 'seekYoutube',
					data:{
						time: player.getCurrentTime()
					}
				}));
				//player.seekTo(200,true);
			}
		}
	}
	
	function stopVideo() {
		player.stopVideo();
	}
  </script>
  
 <script>
	function openPopup(popid) {
		document.getElementById('texteditor').style.display = 'none';
		document.getElementById('texteditor2').style.display = 'none';
		document.getElementById('imageuploader').style.display = 'none';
		document.getElementById('imageuploader2').style.display = 'none';
		document.getElementById('youtubeLinker').style.display = 'none';
		document.getElementById(popid).style.display = 'block';
	}

	function closePopup(popid) {
		document.getElementById(popid).style.display = 'none';
	}
</script>
	<br>
<!--     <p>This whiteboard requires at least
     <a href="http://www.mozilla.com/firefox/channel/">Firefox 7 beta</a> or
     <a href="http://www.google.com/landing/chrome/beta/">Chrome 14 beta</a>.</p> -->
</body>
</html>
